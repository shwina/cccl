name: Build and Test cuda-cccl

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  release:
    types: [published]

jobs:
  build-wheel:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cuda-version: [12, 13]
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install CUDA Toolkit ${{ matrix.cuda-version }}
      uses: Jimver/cuda-toolkit@v0.2.15
      with:
        cuda: ${{ matrix.cuda-version == 12 && '12.6.0' || '13.0.0' }}
        method: network
        non-cuda-sub-packages: '["libcublas","libcufft","libcurand","libcusparse","libcusolver","libnvjpeg","libcufile","libnpp"]'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build wheel setuptools-scm cython
        pip install scikit-build-core[pyproject]

    - name: Verify CUDA installation
      run: |
        nvcc --version
        python -c "
        from cuda.cccl._version_utils import detect_cuda_version
        version = detect_cuda_version()
        print(f'Detected CUDA version: {version}')
        expected = ${{ matrix.cuda-version }}
        assert version == expected, f'Expected CUDA {expected}, got {version}'
        "

    - name: Build wheel
      run: |
        cd python/cuda_cccl
        python -m build --wheel
      env:
        CUDA_HOME: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}

    - name: Install wheel with dependencies
      run: |
        cd python/cuda_cccl
        pip install dist/*.whl
        pip install pytest pytest-xdist

    - name: Test package import
      run: |
        python -c "
        import cuda.cccl
        from cuda.cccl import get_include_paths
        paths = get_include_paths()
        print(f'CUDA version: {paths.cuda_version}')
        print(f'Include paths: {paths.as_tuple()}')
        assert paths.cuda_version == ${{ matrix.cuda-version }}
        "

    - name: Run tests
      run: |
        cd python/cuda_cccl
        python -m pytest tests/ -v

    - name: Upload wheel artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wheel-cuda${{ matrix.cuda-version }}-py${{ matrix.python-version }}
        path: python/cuda_cccl/dist/*.whl

  test-installation-scenarios:
    runs-on: ubuntu-latest
    needs: build-wheel
    strategy:
      matrix:
        scenario:
          - name: "no-extras"
            install-cmd: "pip install cuda-cccl"
            test-cmd: "python -c 'import cuda.cccl; print(\"Success\")'"
          - name: "cu12-extra"
            install-cmd: "pip install cuda-cccl[cu12]"
            test-cmd: "python -c 'import cuda.cccl; from cuda.cccl._version_utils import detect_cuda_version; print(f\"CUDA: {detect_cuda_version()}\")'"
          - name: "cu13-extra"
            install-cmd: "pip install cuda-cccl[cu13]"
            test-cmd: "python -c 'import cuda.cccl; from cuda.cccl._version_utils import detect_cuda_version; print(f\"CUDA: {detect_cuda_version()}\")'"

    steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Download wheel artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: wheel-*
        merge-multiple: true

    - name: Test installation scenario - ${{ matrix.scenario.name }}
      run: |
        # Install from local wheel
        pip install *.whl
        ${{ matrix.scenario.test-cmd }}

  publish:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    needs: [build-wheel, test-installation-scenarios]
    permissions:
      id-token: write  # For trusted publishing

    steps:
    - name: Download all wheel artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: wheel-*
        merge-multiple: true

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: .
        skip-existing: true
